<div class="records-container">
  <div class="welcome-back">
    <h2>Welcome Back, {{ getCurrentUserName() }}</h2>
    <p>Manage your child records</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Records</h3>
      <p class="stat-number">{{ records.length }}</p>
    </div>
    <div class="stat-card">
      <h3>This Month</h3>
      <p class="stat-number">{{ getThisMonthCount() }}</p>
    </div>
    <div class="stat-card">
      <h3>This Week</h3>
      <p class="stat-number">{{ getThisWeekCount() }}</p>
    </div>
  </div>

  <div class="header-section">
    <h3>All Records</h3>
    <button class="btn-add" (click)="openPopup()">+ Add New Record</button>
  </div>

  @if (successMessage) {
    <div class="success-message">
      <span>✓ {{ successMessage }}</span>
    </div>
  }

  <div class="records-list">
    @if (isLoading) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading child records...</p>
      </div>
    } @else if (errorMessage) {
      <div class="error-container">
        <p class="error-message">{{ errorMessage }}</p>
        <button class="btn-retry" (click)="retryLoading()">Retry</button>
      </div>
    } @else if (records.length === 0) {
      <p class="no-records">No records found. Click "Add New Record" to create your first entry.</p>
    } @else {
      <div class="accordion-container">
        @for (record of records; track record.id) {
          <div class="accordion-item" [class.expanded]="isExpanded(record.id)">
            <div class="accordion-header" (click)="toggleRecord(record.id)">
              <div class="record-summary">
                <div class="record-main-info">
                  <span class="baby-name">{{ record.babyName }}</span>
                  <span class="record-meta">DOB: {{ record.dob }} | {{ record.gender }}</span>
                </div>
                <div class="parent-info">
                  <span>Mother: {{ record.motherName }}</span>
                  <span class="separator">|</span>
                  <span>Father: {{ record.fatherName }}</span>
                </div>
              </div>
              <div class="accordion-actions">
                <span class="expand-icon">{{ isExpanded(record.id) ? '−' : '+' }}</span>
              </div>
            </div>

            @if (isExpanded(record.id)) {
              <div class="accordion-content">
                <div class="detail-grid">
                  <div class="detail-item">
                    <span class="detail-label">Contact Number</span>
                    <span class="detail-value">{{ record.contactNo }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Email</span>
                    <span class="detail-value">{{ record.email || 'Not provided' }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Address</span>
                    <span class="detail-value">{{ record.address }}. PIN Code: {{ record.pin }}</span>
                  </div>
                </div>
                <div class="accordion-footer">
                  <button class="btn-edit" (click)="openEditPopup(record); $event.stopPropagation()">Edit Record</button>
                  <button class="btn-delete" (click)="deleteRecord(record.id); $event.stopPropagation()">Delete Record</button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Popup Modal -->
@if (showPopup) {
  <div class="modal-overlay" (click)="closePopup()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditMode ? 'Edit Record' : 'Add New Record' }}</h3>
        <button class="close-btn" (click)="closePopup()">&times;</button>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button type="button" class="tab-btn" [class.active]="currentTab === 'child'" (click)="currentTab = 'child'">
          Basic Information
        </button>
        <button type="button" class="tab-btn" [class.active]="currentTab === 'parent'" [disabled]="!isFirstTabSaved" (click)="isFirstTabSaved && (currentTab = 'parent')">
          Address & Details
        </button>
      </div>

      <form (ngSubmit)="onSubmit()" #recordForm="ngForm">
        <!-- Tab 1: Basic Information -->
        @if (currentTab === 'child') {
          <div class="form-grid tab-content">
            <div class="form-group">
              <label for="babyName">Baby Name</label>
              <input type="text" id="babyName" name="babyName" [(ngModel)]="newRecord.babyName">
            </div>

            <div class="form-group">
              <label>Gender</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="gender" value="Male" [(ngModel)]="newRecord.gender">
                  <span>Male</span>
                </label>
                <label class="radio-label">
                  <input type="radio" name="gender" value="Female" [(ngModel)]="newRecord.gender">
                  <span>Female</span>
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="motherName">Mother's Name</label>
              <input type="text" id="motherName" name="motherName" [(ngModel)]="newRecord.motherName">
            </div>

            <div class="form-group">
              <label for="fatherName">Father's Name</label>
              <input type="text" id="fatherName" name="fatherName" [(ngModel)]="newRecord.fatherName">
            </div>

            <div class="form-group">
              <label for="dob">Date of Birth</label>
              <input type="date" id="dob" name="dob" [(ngModel)]="newRecord.dob">
            </div>

            <div class="form-group">
              <label for="contactNo">Contact Number</label>
              <input type="tel" id="contactNo" name="contactNo" [(ngModel)]="newRecord.contactNo"
                     #contactNo="ngModel" pattern="[0-9]{10}" maxlength="10"
                     (blur)="onFieldBlur(contactNo)">
              @if (contactNo.invalid && (contactNo.dirty || contactNo.touched)) {
                <span class="error-text">Contact number must be exactly 10 digits</span>
              }
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-save" (click)="saveFirstTab()">Save</button>
          </div>
        }

        <!-- Tab 2: Address & Other Details -->
        @if (currentTab === 'parent') {
          <div class="form-grid tab-content">
            <div class="form-group">
              <label for="state">State</label>
              <select id="state" name="state" [(ngModel)]="newRecord.state" (change)="onStateChange($any($event.target).value)">
                <option value="">Select State</option>
                @for (state of states; track state) {
                  <option [value]="state">{{ state }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="district">District</label>
              <select id="district" name="district" [(ngModel)]="newRecord.district" [disabled]="!newRecord.state">
                <option value="">Select District</option>
                @for (district of filteredDistricts; track district) {
                  <option [value]="district">{{ district }}</option>
                }
              </select>
            </div>

            <div class="form-group full-width">
              <label for="address">Address</label>
              <input type="text" id="address" name="address" [(ngModel)]="newRecord.address">
            </div>

            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" name="email" [(ngModel)]="newRecord.email"
                     #email="ngModel" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                     (blur)="onFieldBlur(email)">
              @if (email.invalid && (email.dirty || email.touched)) {
                <span class="error-text">Please enter a valid email address</span>
              }
            </div>

            <div class="form-group">
              <label for="pin">PIN Code</label>
              <input type="text" id="pin" name="pin" [(ngModel)]="newRecord.pin"
                     #pin="ngModel" pattern="[0-9]{6}" maxlength="6"
                     (blur)="onFieldBlur(pin)">
              @if (pin.invalid && (pin.dirty || pin.touched)) {
                <span class="error-text">PIN code must be exactly 6 digits</span>
              }
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-save" (click)="saveSecondTab()">Save</button>
          </div>
        }
      </form>
    </div>
  </div>
}
